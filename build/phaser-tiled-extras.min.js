Phaser.Tilemap.prototype.getImageLayerByName=function(e){for(var r in this.imageLayers)if(this.imageLayers[r].name===e)return this.imageLayers[r];return null},Phaser.Tilemap.prototype.addImageLayer=function(e,r){this.setCurrentMap();var t,i,a,s=this.game.cache._tilemaps[this.key].data.layers,o=this.game,p=[];this.hasOwnProperty("imageLayers")||(this.imageLayers=[]);for(var l in s)if("imagelayer"===s[l].type&&(s[l].hasOwnProperty("properties")||(s[l].properties={}),!e||e===s[l].name)){if(r)t=r;else if(s[l].properties.hasOwnProperty("key"))t=s[l].properties.key;else{var h=Object.keys(o.cache._images),n=s[l].image.replace(/.*?\//g,"");for(var g in h)if("__default"!==h[g]&&"__missing"!==h[g]&&o.cache._images[h[g]].url.indexOf("/"+n)>0){t=h[g];break}!t&&o.cache._images.hasOwnProperty(s[l].name)&&(t=s[l].name)}if(!t){console.warn("Couldn't decide imageKey!");continue}if(!o.cache._images.hasOwnProperty(t)){console.warn("No image with key:"+t);continue}if(i=o.cache._images[t],a={name:s[l].name,canBeSprite:s[l].properties.hasOwnProperty("forceTileSprite")&&"false"!==s[l].properties.forceTileSprite?!1:!0,x:s[l].x,y:s[l].y,width:i.data.width,height:i.data.height,imageKey:t,posFixedToCamera:{x:!1,y:!1},alpha:s[l].opacity,tint:s[l].properties.hasOwnProperty("tint")?parseInt(s[l].properties.tint.replace("#",""),16):16777215,scale:{x:1,y:1},adjustTilePosition:{x:0,y:0},velocity:{x:0,y:0},tilePostionOffset:{x:0,y:0},parallax:{x:1,y:1},exists:"false"!==s[l].visible},s[l].properties.hasOwnProperty("bottom")?a.y=this.heightInPixels-i.data.height+parseInt(s[l].properties.bottom,10):s[l].properties.hasOwnProperty("top")&&(a.y=parseInt(s[l].properties.top,10)),s[l].properties.hasOwnProperty("right")&&(a.x=this.widthInPixels-i.data.width+parseInt(s[l].properties.right,10)),s[l].properties.hasOwnProperty("left")&&(a.y=parseInt(s[l].properties.left,10)),s[l].properties.hasOwnProperty("repeat")&&"true"==s[l].properties.repeat&&(a.x=0,a.y=0,a.width=o.width,a.height=o.height,a.posFixedToCamera.x=!0,a.posFixedToCamera.y=!0,a.canBeSprite=!1),s[l].properties.hasOwnProperty("repeat-x")&&"true"==s[l].properties["repeat-x"]&&(a.x=0,a.width=o.width,a.posFixedToCamera.x=!0,a.canBeSprite=!1),s[l].properties.hasOwnProperty("repeat-y")&&"true"==s[l].properties["repeat-y"]&&(a.y=0,a.height=o.height,a.posFixedToCamera.y=!0,a.canBeSprite=!1),s[l].properties.hasOwnProperty("scale")&&(a.scale.x=parseFloat(s[l].properties.scale),a.scale.y=parseFloat(s[l].properties.scale),a.width/=a.scale.x,a.height/=a.scale.y),s[l].properties.hasOwnProperty("scale.x")&&(a.scale.x=parseFloat(s[l].properties["scale.x"],10)),s[l].properties.hasOwnProperty("scale.y")&&(a.scale.y=parseFloat(s[l].properties["scale.y"],10)),a.velocity.x=s[l].properties.hasOwnProperty("velocity.x")?parseFloat(s[l].properties["velocity.x"]):a.velocity.x,a.velocity.y=s[l].properties.hasOwnProperty("velocity.y")?parseFloat(s[l].properties["velocity.y"]):a.velocity.y,s[l].properties.hasOwnProperty("parallax")&&parseFloat(s[l].properties.parallax)>0&&(a.parallax={x:parseFloat(s[l].properties.parallax),y:parseFloat(s[l].properties.parallax)},a.canBeSprite=!1),a.canBeSprite)var y=o.add.sprite(a.x,a.y,a.imageKey);else var y=o.add.tileSprite(a.x,a.y,a.width,a.height,a.imageKey);var c=Object.keys(a);for(var d in c)y[c[d]]=a[c[d]];p.push(y),this.imageLayers.push(y)}return 0===p.length?!1:1===p.length?p[0]:p},Phaser.Tilemap.prototype.getImageLayerByName=function(e){for(var r in this.imageLayers)if(this.imageLayers[r].name===e)return this.imageLayers[r];return null},Phaser.Tilemap.prototype.addImageLayer=function(e,r){this.setCurrentMap();var t,i,a,s=this.game.cache._tilemaps[this.key].data.layers,o=this.game,p=[];this.hasOwnProperty("imageLayers")||(this.imageLayers=[]);for(var l in s)if("imagelayer"===s[l].type&&(s[l].hasOwnProperty("properties")||(s[l].properties={}),!e||e===s[l].name)){if(r)t=r;else if(s[l].properties.hasOwnProperty("key"))t=s[l].properties.key;else{var h=Object.keys(o.cache._images);for(var n in h)"__default"!==h[n]&&"__missing"!==h[n]&&o.cache._images[h[n]].url.indexOf("/"+s[l].image)>0&&(t=h[n])}if(!t){console.warn("Couldn't decide imageKey!");continue}if(!o.cache._images.hasOwnProperty(t)){console.warn("No image with key:"+t);continue}i=o.cache._images[t],a=o.add.tileSprite(s[l].x,s[l].y,i.data.width,i.data.height,t),a.posFixedToCamera={x:!1,y:!1},a.relativePosition={x:a.x,y:a.y},s[l].properties.hasOwnProperty("bottom")?a.y=this.heightInPixels-i.data.height+parseInt(s[l].properties.bottom,10):s[l].properties.hasOwnProperty("top")&&(a.y=parseInt(s[l].properties.top,10)),s[l].properties.hasOwnProperty("right")&&(a.x=this.widthInPixels-i.data.width+parseInt(s[l].properties.right,10)),s[l].properties.hasOwnProperty("left")&&(a.y=parseInt(s[l].properties.left,10)),s[l].properties.hasOwnProperty("repeat")&&"true"==s[l].properties.repeat&&(a.x=0,a.y=0,a.width=o.width,a.height=o.height,a.posFixedToCamera.x=!0,a.posFixedToCamera.y=!0),s[l].properties.hasOwnProperty("repeat-x")&&"true"==s[l].properties["repeat-x"]&&(a.x=0,a.width=o.width,a.posFixedToCamera.x=!0),s[l].properties.hasOwnProperty("repeat-y")&&"true"==s[l].properties["repeat-y"]&&(a.y=0,a.height=o.height,a.posFixedToCamera.y=!0),s[l].properties.hasOwnProperty("tint")&&(a.tint=s[l].properties.tint),s[l].properties.hasOwnProperty("scale")&&(a.scale.x=parseFloat(s[l].properties.scale),a.scale.y=parseFloat(s[l].properties.scale),a.width/=a.scale.x,a.height/=a.scale.y),s[l].properties.hasOwnProperty("scale.x")&&(a.scale.x=parseFloat(s[l].properties["scale.x"],10)),s[l].properties.hasOwnProperty("scale.y")&&(a.scale.y=parseFloat(s[l].properties["scale.y"],10)),a.displace={x:0,y:0},a.velocity={x:0,y:0},a.offset={x:0,y:0},s[l].properties.hasOwnProperty("velocity")&&(a.velocity.x=parseFloat(s[l].properties.velocity),a.velocity.y=parseFloat(s[l].properties.velocity)),a.velocity.x=s[l].properties.hasOwnProperty("velocity.x")?parseFloat(s[l].properties["velocity.x"]):a.velocity.x,a.velocity.y=s[l].properties.hasOwnProperty("velocity.y")?parseFloat(s[l].properties["velocity.y"]):a.velocity.y,a.alpha=s[l].opacity,a.parallax={x:1,y:1},s[l].properties.hasOwnProperty("parallax")&&parseFloat(s[l].properties.parallax)>0&&(a.parallax={x:parseFloat(s[l].properties.parallax),y:parseFloat(s[l].properties.parallax)}),"false"===s[l].visible&&(a.exists=!1),a.name=s[l].name,p.push(a),this.imageLayers.push(a)}return 0===p.length?!1:1===p.length?p[0]:p},Phaser.Plugin.TiledExtras=function(e,r){this.game=e,this.name="tiledExtras",this.map=null,this.parent=r},Phaser.Plugin.TiledExtras.prototype=Object.create(Phaser.Plugin.prototype),Phaser.Plugin.TiledExtras.prototype.constructor=Phaser.Plugin.TiledExtras,Phaser.Plugin.TiledExtras.prototype.postUpdate=function(){var e=this.map;if(e.hasOwnProperty("triggers"))for(var r in e.triggers)e.triggers[r].enabled&&e.triggers[r].callback&&e.triggers[r].callback(e.triggers[r],null,!0),e.triggers[r].newLoop=!0;if(e.hasOwnProperty("imageLayers"))for(var r in e.imageLayers)0!=e.imageLayers[r].type&&(e.imageLayers[r].tilePostionOffset.x+=e.imageLayers[r].velocity.x*this.game.time.physicsElapsed,e.imageLayers[r].tilePostionOffset.y+=e.imageLayers[r].velocity.y*this.game.time.physicsElapsed,e.imageLayers[r].posFixedToCamera.x&&(e.imageLayers[r].tilePostionOffset.x+=(e.imageLayers[r].x-e.game.camera.x)*e.imageLayers[r].parallax.x,e.imageLayers[r].x=e.game.camera.x),e.imageLayers[r].posFixedToCamera.y&&(e.imageLayers[r].tilePostionOffset.y+=(e.imageLayers[r].y-e.game.camera.y)*e.imageLayers[r].parallax.y,e.imageLayers[r].y=e.game.camera.y),e.imageLayers[r].tilePosition.x=e.imageLayers[r].tilePostionOffset.x+e.imageLayers[r].adjustTilePosition.x,e.imageLayers[r].tilePosition.y=e.imageLayers[r].tilePostionOffset.y+e.imageLayers[r].adjustTilePosition.y)},Phaser.Plugin.TiledExtras.prototype.render=function(){var e;if(this.debug)for(var r in this.map.triggers)e="rgba(100,100,255,0.9)",this.map.triggers[r].trigged&&(e="rgba(255,100,100,0.9)"),game.debug.geom({x:this.map.triggers[r].area.x,y:this.map.triggers[r].area.y,width:this.map.triggers[r].area.width,height:this.map.triggers[r].area.height},e,this.map.triggers[r].enabled,1)},Phaser.Tilemap.prototype.setCurrentMap=function(){var e=this.game;for(var r in e.plugins.plugins)if(e.plugins.plugins[r].hasOwnProperty("name")&&"tiledExtras"===e.plugins.plugins[r].name)return void(e.plugins.plugins[r].map=this)},Phaser.Tilemap.prototype.gidToTileProperties=function(e){for(var r in this.tilesets)if(this.tilesets[r].containsTileIndex(e))return this.tilesets[r].tileProperties.hasOwnProperty(e-this.tilesets[r].firstgid)?this.tilesets[r].tileProperties[e-this.tilesets[r].firstgid]:{};return console.warn("No tileset contain Gid: "+e),null},Phaser.Tilemap.prototype.tilePropertyToGid=function(e,r){var t,i,a;if("undefined"==typeof e)return void console.warn("tilePropertyToGid was called without value parameter.");for(("undefined"==typeof r||null===r)&&(r="type"),i=0;i<this.tilesets.length;i++)if(this.tilesets[i].hasOwnProperty("tileProperties"))for(t=Object.keys(this.tilesets[i].tileProperties),a=0;a<t.length;a++)if(this.tilesets[i].tileProperties[t[a]].hasOwnProperty(r)&&this.tilesets[i].tileProperties[t[a]][r]===e)return parseInt(t[a],10)+parseInt(this.tilesets[i].firstgid,10);return console.warn("Oh no! No GID found for: "+r+"="+e),!1},Phaser.TilemapLayer.prototype.setCollisionArea=function(e,r){if(r)var t={x:r.x,y:r.y,x1:r.x+r.width,y1:r.y+r.height};else var t={x:0,y:0,x1:this.map.width,y1:this.map.height};for(var i=t.y;i<t.y1;i++)for(var a=t.x;a<t.x1;a++)tile=this.map.getTile(a,i,this),tile.collideUp=!0,tile.collideRight=!0,tile.collideDown=!0,tile.collideLeft=!0,tile.collides=!0,tile.faceTop=!0,tile.faceRight=!0,tile.faceBottom=!0,tile.faceLeft=!0},Phaser.TilemapLayer.prototype.updateCollision=function(e,r){var t,i=["Up","Right","Down","Left"],a=[!1,!1,!1,!1];if(e)var s={x:e.x,y:e.y,x1:e.x+e.width,y1:e.y+e.height};else var s={x:0,y:0,x1:this.map.width,y1:this.map.height};for(var o=s.y;o<s.y1;o++)for(var p=s.x;p<s.x1;p++)if(a=[!1,!1,!1,!1],t=this.map.getTile(p,o,this))if(r)t.collideUp=!1,t.collideRight=!1,t.collideDown=!1,t.collideLeft=!1,t.collides=!1,t.faceTop=!1,t.faceRight=!1,t.faceBottom=!1,t.faceLeft=!1;else{t.properties.hasOwnProperty("collideAll")&&"true"===t.properties.collideAll&&(a=[!0,!0,!0,!0]);for(var l=0;4>l;l++)t.properties.hasOwnProperty("collide"+i[l])&&(a[l]="true"===t.properties["collide"+i[l]]?!0:!1);if(t.flipped&&(a=[a[0],a[3],a[2],a[1]]),t.rotation>0)switch(Math.round(2*t.rotation/Math.PI)){case 1:a=[a[3],a[0],a[1],a[2]];break;case 2:a=[a[2],a[3],a[0],a[1]];break;case 3:a=[a[1],a[2],a[3],a[0]]}t.collideUp=a[0],t.collideRight=a[1],t.collideDown=a[2],t.collideLeft=a[3],t.collides=a[0]||a[1]||a[2]||a[3]}this.map.calculateFaces(this.index)},Phaser.Tilemap.prototype.getTriggerByName=function(e){return e in this.triggerNames?this.triggerNames[e]:!1},Phaser.Tilemap.prototype.checkTriggers=function(e){var r,t,i;if(!this.hasOwnProperty("triggers"))return void console.warn("checkTriggers called before defineTriggers!");if(this.triggers){switch(e.type){case 0:r={x:0,y:0},t=[e];break;case 7:r={x:e.x,y:e.y},t=e.children}for(var a in t){e=t[a];var i={left:e.body.position.x,right:e.body.position.x+e.body.width-(Math.abs(e.width)-e.body.width),top:e.body.position.y,bottom:e.body.position.y+e.body.height-(Math.abs(e.height)-e.body.height),anchorX:e.x,anchorY:e.y};for(var s in this.triggers)if(this.triggers[s].enabled){if(this.triggers[s].required)switch(this.triggers[s].required.operator){case"==":if(e[this.triggers[s].required.property]!=this.triggers[s].required.value)continue;break;case"!=":if(e[this.triggers[s].required.property]!=this.triggers[s].required.value)continue;break;case"<=":if(e[this.triggers[s].required.property]>this.triggers[s].required.value)continue;break;case">=":if(e[this.triggers[s].required.property]<this.triggers[s].required.value)continue;break;case"<":if(e[this.triggers[s].required.property]>=this.triggers[s].required.value)continue;break;case">":if(e[this.triggers[s].required.property]<=this.triggers[s].required.value)continue}this.triggers[s].newLoop&&(this.triggers[s].wasTrigged=this.triggers[s].trigged,this.triggers[s].endorsers=[],this.triggers[s].newLoop=!1),i.anchorX<this.triggers[s].area.x2&&i.anchorX>this.triggers[s].area.x&&i.anchorY<this.triggers[s].area.y2&&i.anchorY>this.triggers[s].area.y?(this.triggers[s].trigged=!0,this.triggers[s].endorsers.push(e),this.triggers[s].callback&&this.triggers[s].callback(this.triggers[s],e)):this.triggers[s].wasTrigged&&0===this.triggers[s].endorsers.length&&(this.triggers[s].trigged=!1,this.triggers[s].callback&&this.triggers[s].callback(this.triggers[s],e))}}}},Phaser.Tilemap.prototype.defineTriggers=function(){if(this.setCurrentMap(),!this.objects.hasOwnProperty("triggers"))return this.triggers=null,void(this.triggerNames=null);this.triggers=[],this.triggerNames=[];for(var e,r,t=this.objects.triggers,i=null,a=0,s=t.length;s>a;a++){e={},r=Object.keys(t[a].properties);var o={name:t[a].hasOwnProperty("name")?t[a].name:null,enabled:!t[a].properties.hasOwnProperty("enabled")||"true"!==t[a].properties.enabled,callback:null,args:[],area:{x:t[a].x,y:t[a].y,width:t[a].width,height:t[a].height,x2:t[a].x+t[a].width,y2:t[a].y+t[a].height},trigged:!1,wasTrigged:!1,endorsers:[],detectAnchorOnly:t[a].properties.detectAnchorOnly,required:null,_resetEndorsers:!0};for(var p in r)"callback"!==r[p]&&"required"!==r[p]&&(e[r[p]]=t[a].properties[r[p]]);if(o.args=e,t[a].properties.hasOwnProperty("required")){for(var l=["<=",">=","==","<",">","!=",!1],p=0;7>p&&!(t[a].properties.required.indexOf(l[p])>-1);p++);l[p]&&(i=t[a].properties.required.split(l[p]),i[1]=i[1].replace(/\"/g,"").replace(/\'/g,""),parseFloat(i[1])==i[1]&&(i[1]=parseFloat(i[1])),o.required={property:i[0],operator:l[p],value:"true"===i[1]?!0:"false"===i[1]?!1:i[1]})}t[a].properties.hasOwnProperty("detectAnchorOnly")?"false"!==t[a].properties.detectAnchorOnly&&(o.detectAnchorOnly=!0):o.detectAnchorOnly=!1;var h=null;if(t[a].properties.hasOwnProperty("callback")){h=window;var n=t[a].properties.callback.split(".");for(var p in n){if(!h.hasOwnProperty(n[p])){h=null,console.warn("Trigger callback not found: "+n[p]);break}h=h[n[p]]}o.callback=h}this.triggers.push(o),t[a].hasOwnProperty("name")&&t[a].name&&(this.triggerNames.hasOwnProperty(t[a].name)?console.warn("Duplicate trigger name: "+t[a].name+"\ngetTriggerByName will fail!"):this.triggerNames[t[a].name]=this.triggers.length-1)}0===this.triggers.length&&(this.triggers=null,this.triggerNames=null)};