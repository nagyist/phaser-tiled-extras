Phaser.Tilemap.prototype.getImageLayerByName=function(e){for(var t in map.imageLayers)if(map.imageLayers[t].name===e)return map.imageLayers[t];return null},Phaser.Tilemap.prototype.addImageLayer=function(e,t){this.setDefault();var r=this.game.cache._tilemaps[this.key].data.layers,i=this.game,a=[];this.hasOwnProperty("imageLayers")||(this.imageLayers=[]);for(var s in r)if("imagelayer"===r[s].type&&(!e||e===r[s].name)){if(t)imageKey=t;else if(r[s].properties.hasOwnProperty("key"))imageKey=r[s].properties.key;else if(i.cache._images.hasOwnProperty(r[s].name))imageKey=r[s].name;else{var o=Object.keys(i.cache._images);for(var p in o)"__default"!==o[p]&&"__missing"!==o[p]&&i.cache._images[o[p]].url.indexOf("/"+r[s].image)>0&&(imageKey=o[p])}if(!imageKey){console.warn("Couldn't decide imageKey!");continue}if(!i.cache._images.hasOwnProperty(imageKey)){console.warn("No image with key:"+imageKey);continue}if(image=i.cache._images[imageKey],object=i.add.tileSprite(r[s].x,r[s].y,image.data.width,image.data.height,imageKey),object.posFixedToCamera={x:!1,y:!1},object.relativePosition={x:object.x,y:object.y},r[s].properties.hasOwnProperty("bottom")&&(object.y=this.heightInPixels-image.data.height+parseInt(r[s].properties.bottom)),r[s].properties.hasOwnProperty("imageRepeat"))switch(r[s].properties.imageRepeat){case"repeat":object.x=0,object.y=0,object.width=i.width,object.height=i.height,object.posFixedToCamera.x=!0,object.posFixedToCamera.y=!0;break;case"repeat-x":object.x=0,object.width=i.width,object.posFixedToCamera.x=!0;break;case"repeat-y":object.y=0,object.width=i.width,object.posFixedToCamera.y=!0}r[s].properties.hasOwnProperty("tint")&&(object.tint=r[s].properties.tint),r[s].properties.hasOwnProperty("scale")&&(object.scale.x=parseFloat(r[s].properties.scale),object.scale.y=parseFloat(r[s].properties.scale),object.width/=object.scale.x,object.height/=object.scale.y),r[s].properties.hasOwnProperty("scale.x")&&(object.scale.x=parseFloat(r[s].properties["scale.x"])),r[s].properties.hasOwnProperty("scale.y")&&(object.scale.y=parseFloat(r[s].properties["scale.y"])),object.displace={x:0,y:0},object.velocity={x:0,y:0},object.offset={x:0,y:0},r[s].properties.hasOwnProperty("velocity")&&(object.velocity.x=parseFloat(r[s].properties.velocity),object.velocity.y=parseFloat(r[s].properties.velocity)),object.velocity.x=r[s].properties.hasOwnProperty("velocity.x")?parseFloat(r[s].properties["velocity.x"]):object.velocity.x,object.velocity.y=r[s].properties.hasOwnProperty("velocity.y")?parseFloat(r[s].properties["velocity.y"]):object.velocity.y,object.alpha=r[s].opacity,object.parallax={x:1,y:1},r[s].properties.hasOwnProperty("parallax")&&parseFloat(r[s].properties.parallax)>0&&(object.parallax={x:parseFloat(r[s].properties.parallax),y:parseFloat(r[s].properties.parallax)}),object.name=r[s].name,a.push(object),this.imageLayers.push(object)}return 0===a.length?!1:1===a.length?a[0]:a},Phaser.Tilemap.prototype.loadSprites=function(e,t,r){e||(e="sprites");var i=!1;keys=Object.keys(this.objects);for(var a in keys)if(keys[a]==e){i=this.objects[keys[a]];break}if(!i)return void console.warn("loadSprites failed to identify layer!");for(var a in i){var s=!1,o=t;if(i[a].gid){if(""!==i[a].type)s=i[a].type;else{var p=this.gidToTileProperties(i[a].gid);p.hasOwnProperty("type")&&(s=p.type)}s&&""!==s&&(console.log("Load"+s),themap.createFromObjects(e,i[a].gid,o,null,!0,null,r,window[s]))}}},Phaser.Tilemap.prototype.gidToTileProperties=function(e){console.log(this);for(var t in this.tilesets)if(this.tilesets[t].containsTileIndex(e))return this.tilesets[t].tileProperties.hasOwnProperty(e-this.tilesets[t].firstgid)?this.tilesets[t].tileProperties[e-this.tilesets[t].firstgid]:!1;console.warn("No tileset contain "+e)},Phaser.Tilemap.prototype.tilePropertyToGid=function(e,t){var r,i,a;for(("undefined"==typeof t||null===t)&&(t="type"),i=0;i<this.tilesets.length;i++)if(this.tilesets[i].hasOwnProperty("tileProperties"))for(r=Object.keys(this.tilesets[i].tileProperties),a=0;a<r.length;a++)if(this.tilesets[i].tileProperties[r[a]].hasOwnProperty(t)&&this.tilesets[i].tileProperties[r[a]][t]===e)return parseInt(r[a],10)+parseInt(this.tilesets[i].firstgid,10);return console.log("Error! No GID found:"+e),!1},Phaser.TilemapLayer.prototype.updateCollision=function(e,t){var r,i=["Up","Right","Down","Left"],s=[!1,!1,!1,!1];a=e?{x:e.x,y:e.y,x1:e.x+e.width,y1:e.y+e.height}:{x:0,y:0,x1:this.map.width,y1:this.map.height};for(var o=a.y;o<a.y1;o++)for(var p=a.x;p<a.x1;p++)if(s=[!1,!1,!1,!1],r=this.map.getTile(p,o,this))if(t)r.collideUp=!1,r.collideRight=!1,r.collideDown=!1,r.collideLeft=!1,r.collides=!1,r.faceTop=!1,r.faceRight=!1,r.faceBottom=!1,r.faceLeft=!1;else{r.properties.hasOwnProperty("collideAll")&&"true"===r.properties.collideAll&&(s=[!0,!0,!0,!0]);for(var g=0;4>g;g++)r.properties.hasOwnProperty("collide"+i[g])&&(s[g]="true"===r.properties["collide"+i[g]]?!0:!1);if(r.flipped&&(s=[s[0],s[3],s[2],s[1]]),r.rotation>0)switch(Math.round(2*r.rotation/Math.PI)){case 1:s=[s[3],s[0],s[1],s[2]];break;case 2:s=[s[2],s[3],s[0],s[1]];break;case 3:s=[s[1],s[2],s[3],s[0]]}r.collideUp=s[0],r.collideRight=s[1],r.collideDown=s[2],r.collideLeft=s[3],r.collides=s[0]||s[1]||s[2]||s[3],r.faceTop=s[0],r.faceRight=s[1],r.faceBottom=s[2],r.faceLeft=s[3]}},Phaser.Plugin.TiledExtras=function(e){this.game=e,this.name="tiledExtras",this.map=null},Phaser.Plugin.TiledExtras.prototype=Object.create(Phaser.Plugin.prototype),Phaser.Plugin.TiledExtras.prototype.constructor=Phaser.Plugin.TiledExtras,Phaser.Plugin.TiledExtras.prototype.postUpdate=function(){if(map=this.map,map.hasOwnProperty("triggers"))for(var e in map.triggers)map.triggers[e].enabled&&map.triggers[e].callback&&map.triggers[e].callback(map.triggers[e],null,!0),map.triggers[e].newLoop=!0;if(map.hasOwnProperty("imageLayers"))for(var e in map.imageLayers)map.imageLayers[e].offset.x+=map.imageLayers[e].velocity.x*this.game.time.physicsElapsed,map.imageLayers[e].offset.y+=map.imageLayers[e].velocity.y*this.game.time.physicsElapsed,map.imageLayers[e].posFixedToCamera.x&&(map.imageLayers[e].offset.x+=(map.imageLayers[e].x-map.game.camera.x)*map.imageLayers[e].parallax.x,map.imageLayers[e].x=map.game.camera.x),map.imageLayers[e].posFixedToCamera.y&&(map.imageLayers[e].offset.y+=(map.imageLayers[e].y-map.game.camera.y)*map.imageLayers[e].parallax.y,map.imageLayers[e].y=map.game.camera.y),map.imageLayers[e].tilePosition.x=map.imageLayers[e].offset.x+map.imageLayers[e].displace.x,map.imageLayers[e].tilePosition.y=map.imageLayers[e].offset.y+map.imageLayers[e].displace.y},Phaser.Tilemap.prototype.setDefault=function(){game=this.game;for(var e in game.plugins.plugins)if(game.plugins.plugins[e].hasOwnProperty("name")&&"tiledExtras"===game.plugins.plugins[e].name)return void(game.plugins.plugins[e].map=this)},Phaser.Plugin.TiledExtras.Triggers=function(e){this.game=e,this.map=map,this.triggers=[],this.triggerNames=[],this._resetTests=!1},Phaser.Tilemap.prototype.getTriggerByName=function(e){return e in this.triggerNames?this.triggerNames[e]:!1},Phaser.Tilemap.prototype.checkTriggers=function(e){var t,r,i;if(!this.hasOwnProperty("triggers"))return void console.warn("checkTriggers called before defineTriggers!");if(this.triggers){switch(e.type){case 0:t={x:0,y:0},r=[e];case 7:t={x:e.x,y:e.y},r=e.children}for(var a in r){e=r[a];var i={leftX:e.x+t.x,topY:e.y+t.y,toX:e.x+t.x,rightX:e.x+t.x,rightY:e.y+t.y,anchorX:e.x+t.x,anchorY:e.y+t.y};for(var s in this.triggers)this.triggers[s].enabled&&(this.triggers[s].newLoop&&(this.triggers[s].wasTrigged=this.triggers[s].trigged,this.triggers[s].endorsers=[],this.triggers[s].newLoop=!1),this.triggers[s].required&&e.hasOwnProperty(this.triggers[s].required.property)&&e[this.triggers[s].required.property]!==this.triggers[s].required.value||this.triggers[s].forbidden&&e.hasOwnProperty(this.triggers[s].forbidden.property)&&e[this.triggers[s].forbidden.property]===this.triggers[s].forbidden.value||(i.anchorX<this.triggers[s].x1&&i.anchorX>this.triggers[s].x0&&i.anchorY<this.triggers[s].y1&&i.anchorY>this.triggers[s].y0?(this.triggers[s].trigged=!0,this.triggers[s].endorsers.push(e),this.triggers[s].callback&&this.triggers[s].callback(this.triggers[s],e)):this.triggers[s].wasTrigged&&0===this.triggers[s].endorsers.length&&(this.triggers[s].trigged=!1,this.triggers[s].callback&&this.triggers[s].callback(this.triggers[s],e))))}}},Phaser.Tilemap.prototype.defineTriggers=function(){if(this.setDefault(),!this.objects.hasOwnProperty("triggers"))return this.triggers=null,void(this.triggerNames=null);this.triggers=[],this.triggerNames=[];for(var e,t,r=this.objects.triggers,i=null,a=null,s=0,o=r.length;o>s;s++){e={},t=Object.keys(r[s].properties);for(var p in t)"callback"!==t[p]&&"required"!==t[p]&&"forbidden"!==t[p]&&(e[t[p]]=r[s].properties[t[p]]);r[s].properties.hasOwnProperty("forbidden")&&(i=r[s].properties.forbidden.split("="),i={property:i[0],value:"true"===i[1]?!0:"false"===i[1]?!1:i[1]}),r[s].properties.hasOwnProperty("detectAnchorOnly")?"false"!==r[s].properties.detectAnchorOnly&&(r[s].properties.detectAnchorOnly=!0):r[s].properties.detectAnchorOnly=!1;var g=null;if(r[s].properties.hasOwnProperty("callback")){g=window;var l=r[s].properties.callback.split(".");for(var p in l){if(!g.hasOwnProperty(l[p])){console.warn("Trigger callback not found: "+l[p]);break}g=g[l[p]]}}this.triggers.push({enabled:!r[s].properties.hasOwnProperty("enabled")||"true"===!r[s].properties.enabled,callback:g,arguments:e,area:{x:r[s].x,y:r[s].y,width:r[s].width,height:r[s].height,x2:r[s].x+r[s].width,y2:r[s].y+r[s].height},x0:r[s].x,y0:r[s].y,width:r[s].width,height:r[s].height,x1:r[s].x+r[s].width,y1:r[s].y+r[s].height,trigged:!1,wasTrigged:!1,endorsers:[],detectAnchorOnly:r[s].properties.detectAnchorOnly,forbidden:i,required:a,newLoop:!0,name:r[s].hasOwnProperty("name")?r[s].name:null}),r[s].hasOwnProperty("name")&&r[s].name&&(this.triggerNames.hasOwnProperty(r[s].name)?console.warn("Duplicate trigger name: "+r[s].name+"\ngetTriggerByName will fail!"):this.triggerNames[r[s].name]=this.triggers.length-1)}0===this.triggers.length&&(this.triggers=null,this.triggerNames=null)};