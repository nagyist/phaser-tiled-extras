Phaser.Tilemap.prototype.getImageLayerByName=function(e){for(var r in this.imageLayers)if(this.imageLayers[r].name===e)return this.imageLayers[r];return null},Phaser.Tilemap.prototype.addImageLayer=function(e,r){this.setCurrentMap();var t,i,s,a=this.game.cache._tilemaps[this.key].data.layers,o=this.game,p=[];this.hasOwnProperty("imageLayers")||(this.imageLayers=[]);for(var l in a)if("imagelayer"===a[l].type&&(a[l].hasOwnProperty("properties")||(a[l].properties={}),!e||e===a[l].name)){if(r)t=r;else if(a[l].properties.hasOwnProperty("key"))t=a[l].properties.key;else{var g=Object.keys(o.cache._images),n=a[l].image.replace(/.*?\//g,"");for(var h in g)if("__default"!==g[h]&&"__missing"!==g[h]&&o.cache._images[g[h]].url.indexOf("/"+n)>0){t=g[h];break}!t&&o.cache._images.hasOwnProperty(a[l].name)&&(t=a[l].name)}if(!t){console.warn("Couldn't decide imageKey!");continue}if(!o.cache._images.hasOwnProperty(t)){console.warn("No image with key:"+t);continue}if(i=o.cache._images[t],s={name:a[l].name,canBeSprite:a[l].properties.hasOwnProperty("forceTileSprite")&&"false"!==a[l].properties.forceTileSprite?!1:!0,x:a[l].x,y:a[l].y,width:i.data.width,height:i.data.height,imageKey:t,posFixedToCamera:{x:!1,y:!1},alpha:a[l].opacity,tint:a[l].properties.hasOwnProperty("tint")?parseInt(a[l].properties.tint.replace("#",""),16):16777215,scale:{x:1,y:1},adjustTilePosition:{x:0,y:0},velocity:{x:0,y:0},tilePostionOffset:{x:0,y:0},parallax:{x:1,y:1},exists:"false"!==a[l].visible},a[l].properties.hasOwnProperty("bottom")?s.y=this.heightInPixels-i.data.height+parseInt(a[l].properties.bottom,10):a[l].properties.hasOwnProperty("top")&&(s.y=parseInt(a[l].properties.top,10)),a[l].properties.hasOwnProperty("right")&&(s.x=this.widthInPixels-i.data.width+parseInt(a[l].properties.right,10)),a[l].properties.hasOwnProperty("left")&&(s.y=parseInt(a[l].properties.left,10)),a[l].properties.hasOwnProperty("repeat")&&"true"==a[l].properties.repeat&&(s.x=0,s.y=0,s.width=o.width,s.height=o.height,s.posFixedToCamera.x=!0,s.posFixedToCamera.y=!0,s.canBeSprite=!1),a[l].properties.hasOwnProperty("repeat-x")&&"true"==a[l].properties["repeat-x"]&&(s.x=0,s.width=o.width,s.posFixedToCamera.x=!0,s.canBeSprite=!1),a[l].properties.hasOwnProperty("repeat-y")&&"true"==a[l].properties["repeat-y"]&&(s.y=0,s.height=o.height,s.posFixedToCamera.y=!0,s.canBeSprite=!1),a[l].properties.hasOwnProperty("scale")&&(s.scale.x=parseFloat(a[l].properties.scale),s.scale.y=parseFloat(a[l].properties.scale),s.width/=s.scale.x,s.height/=s.scale.y),a[l].properties.hasOwnProperty("scale.x")&&(s.scale.x=parseFloat(a[l].properties["scale.x"],10)),a[l].properties.hasOwnProperty("scale.y")&&(s.scale.y=parseFloat(a[l].properties["scale.y"],10)),s.velocity.x=a[l].properties.hasOwnProperty("velocity.x")?parseFloat(a[l].properties["velocity.x"]):s.velocity.x,s.velocity.y=a[l].properties.hasOwnProperty("velocity.y")?parseFloat(a[l].properties["velocity.y"]):s.velocity.y,a[l].properties.hasOwnProperty("parallax")&&parseFloat(a[l].properties.parallax)>0&&(s.parallax={x:parseFloat(a[l].properties.parallax),y:parseFloat(a[l].properties.parallax)},s.canBeSprite=!1),s.canBeSprite)var y=o.add.sprite(s.x,s.y,s.imageKey);else var y=o.add.tileSprite(s.x,s.y,s.width,s.height,s.imageKey);var c=Object.keys(s);for(var d in c)y[c[d]]=s[c[d]];p.push(y),this.imageLayers.push(y)}return 0===p.length?!1:1===p.length?p[0]:p},Phaser.Plugin.TiledExtras=function(e,r){this.game=e,this.name="tiledExtras",this.map=null,this.parent=r},Phaser.Plugin.TiledExtras.prototype=Object.create(Phaser.Plugin.prototype),Phaser.Plugin.TiledExtras.prototype.constructor=Phaser.Plugin.TiledExtras,Phaser.Plugin.TiledExtras.prototype.postUpdate=function(){if(this.map){var e=this.map;if(e.hasOwnProperty("triggers"))for(var r in e.triggers)e.triggers[r].enabled&&e.triggers[r].callback&&e.triggers[r].trigged&&e.triggers[r].callback(e.triggers[r],null,!0),e.triggers[r]._resetEndorsers=!0;if(e.hasOwnProperty("imageLayers"))for(var r in e.imageLayers)0!=e.imageLayers[r].type&&(e.imageLayers[r].tilePostionOffset.x+=e.imageLayers[r].velocity.x*this.game.time.physicsElapsed,e.imageLayers[r].tilePostionOffset.y+=e.imageLayers[r].velocity.y*this.game.time.physicsElapsed,e.imageLayers[r].posFixedToCamera.x&&(e.imageLayers[r].tilePostionOffset.x+=(e.imageLayers[r].x-e.game.camera.x)*e.imageLayers[r].parallax.x,e.imageLayers[r].x=e.game.camera.x),e.imageLayers[r].posFixedToCamera.y&&(e.imageLayers[r].tilePostionOffset.y+=(e.imageLayers[r].y-e.game.camera.y)*e.imageLayers[r].parallax.y,e.imageLayers[r].y=e.game.camera.y),e.imageLayers[r].tilePosition.x=e.imageLayers[r].tilePostionOffset.x+e.imageLayers[r].adjustTilePosition.x,e.imageLayers[r].tilePosition.y=e.imageLayers[r].tilePostionOffset.y+e.imageLayers[r].adjustTilePosition.y)}},Phaser.Plugin.TiledExtras.prototype.render=function(){var e;if(this.debug)for(var r in this.map.triggers)e="rgba(100,100,255,0.9)",this.map.triggers[r].trigged&&(e="rgba(255,100,100,0.9)"),game.debug.geom({x:this.map.triggers[r].area.x,y:this.map.triggers[r].area.y,width:this.map.triggers[r].area.width,height:this.map.triggers[r].area.height},e,this.map.triggers[r].enabled,1)},Phaser.Tilemap.prototype.setCurrentMap=function(){var e=this.game;for(var r in e.plugins.plugins)if(e.plugins.plugins[r].hasOwnProperty("name")&&"tiledExtras"===e.plugins.plugins[r].name)return void(e.plugins.plugins[r].map=this)},Phaser.Tilemap.prototype.gidToTileProperties=function(e){for(var r in this.tilesets)if(this.tilesets[r].containsTileIndex(e))return this.tilesets[r].tileProperties.hasOwnProperty(e-this.tilesets[r].firstgid)?this.tilesets[r].tileProperties[e-this.tilesets[r].firstgid]:{};return console.warn("No tileset contain Gid: "+e),null},Phaser.Tilemap.prototype.tilePropertyToGid=function(e,r){var t,i,s;if("undefined"==typeof e)return void console.warn("tilePropertyToGid was called without value parameter.");for(("undefined"==typeof r||null===r)&&(r="type"),i=0;i<this.tilesets.length;i++)if(this.tilesets[i].hasOwnProperty("tileProperties"))for(t=Object.keys(this.tilesets[i].tileProperties),s=0;s<t.length;s++)if(this.tilesets[i].tileProperties[t[s]].hasOwnProperty(r)&&this.tilesets[i].tileProperties[t[s]][r]===e)return parseInt(t[s],10)+parseInt(this.tilesets[i].firstgid,10);return console.warn("Oh no! No GID found for: "+r+"="+e),!1},Phaser.TilemapLayer.prototype.setCollisionArea=function(e,r){if(r)var t={x:r.x,y:r.y,x1:r.x+r.width,y1:r.y+r.height};else var t={x:0,y:0,x1:this.map.width,y1:this.map.height};for(var i=t.y;i<t.y1;i++)for(var s=t.x;s<t.x1;s++)tile=this.map.getTile(s,i,this),tile.collideUp=!0,tile.collideRight=!0,tile.collideDown=!0,tile.collideLeft=!0,tile.collides=!0,tile.faceTop=!0,tile.faceRight=!0,tile.faceBottom=!0,tile.faceLeft=!0},Phaser.TilemapLayer.prototype.updateCollision=function(e,r){var t,i=["Up","Right","Down","Left"],s=[!1,!1,!1,!1];if(e)var a={x:e.x,y:e.y,x1:e.x+e.width,y1:e.y+e.height};else var a={x:0,y:0,x1:this.map.width,y1:this.map.height};for(var o=a.y;o<a.y1;o++)for(var p=a.x;p<a.x1;p++)if(s=[!1,!1,!1,!1],t=this.map.getTile(p,o,this))if(r)t.collideUp=!1,t.collideRight=!1,t.collideDown=!1,t.collideLeft=!1,t.collides=!1;else{t.properties.hasOwnProperty("collideAll")&&"true"===t.properties.collideAll&&(s=[!0,!0,!0,!0]);for(var l=0;4>l;l++)t.properties.hasOwnProperty("collide"+i[l])&&(s[l]="true"===t.properties["collide"+i[l]]?!0:!1);if(t.flipped&&(s=[s[0],s[3],s[2],s[1]]),t.rotation>0)switch(Math.round(2*t.rotation/Math.PI)){case 1:s=[s[3],s[0],s[1],s[2]];break;case 2:s=[s[2],s[3],s[0],s[1]];break;case 3:s=[s[1],s[2],s[3],s[0]]}t.collideUp=s[0],t.collideRight=s[1],t.collideDown=s[2],t.collideLeft=s[3],t.collides=s[0]||s[1]||s[2]||s[3],t.properties.hasOwnProperty("alpha")&&(t.alpha=parseFloat(t.properties.alpha));var g=null;if(t.properties.hasOwnProperty("callback")){g=window;var n=t.properties.callback.split(".");for(var h in n){if("undefined"==g[n[h]]){g=null,console.warn("Tile callback not found: "+n[h]);break}g=g[n[h]]}t.collisionCallback=g}}this.map.calculateFaces(this.index)},Phaser.Tilemap.prototype.getTriggerByName=function(e){return e in this.triggerNames?this.triggerNames[e]:!1},Phaser.Tilemap.prototype.checkTriggers=function(e){var r,t,i;if(!this.hasOwnProperty("triggers"))return void console.warn("checkTriggers called before defineTriggers!");if(this.triggers){switch(e.type){case 0:r={x:0,y:0},t=[e];break;case 7:r={x:e.x,y:e.y},t=e.children}for(var s in t){e=t[s];var i={left:e.body.position.x,right:e.body.position.x+e.body.width-(Math.abs(e.width)-e.body.width),top:e.body.position.y,bottom:e.body.position.y+e.body.height-(Math.abs(e.height)-e.body.height),anchorX:e.x,anchorY:e.y};for(var a in this.triggers)if(this.triggers[a].enabled){if(this.triggers[a].required)switch(this.triggers[a].required.operator){case"==":if(e[this.triggers[a].required.property]!=this.triggers[a].required.value)continue;break;case"!=":if(e[this.triggers[a].required.property]!=this.triggers[a].required.value)continue;break;case"<=":if(e[this.triggers[a].required.property]>this.triggers[a].required.value)continue;break;case">=":if(e[this.triggers[a].required.property]<this.triggers[a].required.value)continue;break;case"<":if(e[this.triggers[a].required.property]>=this.triggers[a].required.value)continue;break;case">":if(e[this.triggers[a].required.property]<=this.triggers[a].required.value)continue}this.triggers[a]._resetEndorsers&&(this.triggers[a].wasTrigged=this.triggers[a].trigged,this.triggers[a].endorsers=[],this.triggers[a]._resetEndorsers=!1),i.anchorX<this.triggers[a].area.x2&&i.anchorX>this.triggers[a].area.x&&i.anchorY<this.triggers[a].area.y2&&i.anchorY>this.triggers[a].area.y?(this.triggers[a].trigged=!0,this.triggers[a].endorsers.push(e),this.triggers[a].callback&&this.triggers[a].callback(this.triggers[a],e)):this.triggers[a].wasTrigged&&0===this.triggers[a].endorsers.length&&(this.triggers[a].trigged=!1,this.triggers[a].callback&&this.triggers[a].callback(this.triggers[a],e))}}}},Phaser.Tilemap.prototype.defineTriggers=function(){if(this.setCurrentMap(),!this.objects.hasOwnProperty("triggers"))return this.triggers=null,void(this.triggerNames=null);this.triggers=[],this.triggerNames=[];for(var e,r,t=this.objects.triggers,i=null,s=0,a=t.length;a>s;s++){e={},r=Object.keys(t[s].properties);var o={name:t[s].hasOwnProperty("name")?t[s].name:null,enabled:!t[s].properties.hasOwnProperty("enabled")||"true"!==t[s].properties.enabled,callback:null,args:[],area:{x:t[s].x,y:t[s].y,width:t[s].width,height:t[s].height,x2:t[s].x+t[s].width,y2:t[s].y+t[s].height},trigged:!1,wasTrigged:!1,endorsers:[],detectAnchorOnly:t[s].properties.detectAnchorOnly,required:null,_resetEndorsers:!0};for(var p in r)"callback"!==r[p]&&"required"!==r[p]&&(e[r[p]]=t[s].properties[r[p]]);if(o.args=e,t[s].properties.hasOwnProperty("required")){for(var l=["<=",">=","==","<",">","!=",!1],p=0;7>p&&!(t[s].properties.required.indexOf(l[p])>-1);p++);l[p]&&(i=t[s].properties.required.split(l[p]),i[1]=i[1].replace(/\"/g,"").replace(/\'/g,"").replace(/\=\=\=/g,"=="),parseFloat(i[1])==i[1]&&(i[1]=parseFloat(i[1])),o.required={property:i[0],operator:l[p],value:"true"===i[1]?!0:"false"===i[1]?!1:i[1]})}t[s].properties.hasOwnProperty("detectAnchorOnly")?"false"!==t[s].properties.detectAnchorOnly&&(o.detectAnchorOnly=!0):o.detectAnchorOnly=!1;var g=null;if(t[s].properties.hasOwnProperty("callback")){g=window;var n=t[s].properties.callback.split(".");for(var p in n){if("undefined"==g[n[p]]){g=null,console.warn("Trigger callback not found: "+n[p]);break}g=g[n[p]]}o.callback=g}this.triggers.push(o),t[s].hasOwnProperty("name")&&t[s].name&&(this.triggerNames.hasOwnProperty(t[s].name)?console.warn("Duplicate trigger name: "+t[s].name+"\ngetTriggerByName will fail!"):this.triggerNames[t[s].name]=this.triggers.length-1)}0===this.triggers.length&&(this.triggers=null,this.triggerNames=null)};