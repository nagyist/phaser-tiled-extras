Phaser.Tilemap.prototype.getImageLayerByName=function(e){for(var r in this.imageLayers)if(this.imageLayers[r].name===e)return this.imageLayers[r];return null},Phaser.Tilemap.prototype.addImageLayer=function(e,r){this.setCurrentMap();var i,t,a,s=this.game.cache._tilemaps[this.key].data.layers,o=this.game,l=[];this.hasOwnProperty("imageLayers")||(this.imageLayers=[]);for(var p in s)if("imagelayer"===s[p].type&&(s[p].hasOwnProperty("properties")||(s[p].properties={}),!e||e===s[p].name)){if(r)i=r;else if(s[p].properties.hasOwnProperty("key"))i=s[p].properties.key;else{var g=Object.keys(o.cache._images),n=s[p].image.replace(/.*?\//g,"");for(var h in g)if("__default"!==g[h]&&"__missing"!==g[h]&&o.cache._images[g[h]].url.indexOf("/"+n)>0){i=g[h];break}!i&&o.cache._images.hasOwnProperty(s[p].name)&&(i=s[p].name)}if(!i){console.warn("Couldn't decide imageKey!");continue}if(!o.cache._images.hasOwnProperty(i)){console.warn("No image with key:"+i);continue}if(t=o.cache._images[i],a={name:s[p].name,canBeSprite:s[p].properties.hasOwnProperty("forceTileSprite")&&"false"!==s[p].properties.forceTileSprite?!1:!0,x:s[p].x,y:s[p].y,width:t.data.width,height:t.data.height,imageKey:i,posFixedToCamera:{x:!1,y:!1},alpha:s[p].opacity,tint:s[p].properties.hasOwnProperty("tint")?parseInt(s[p].properties.tint.replace("#",""),16):16777215,scale:{x:1,y:1},adjustTilePosition:{x:0,y:0},velocity:{x:0,y:0},tilePostionOffset:{x:0,y:0},parallax:{x:1,y:1},exists:"false"!==s[p].visible},s[p].properties.hasOwnProperty("bottom")?a.y=this.heightInPixels-t.data.height+parseInt(s[p].properties.bottom,10):s[p].properties.hasOwnProperty("top")&&(a.y=parseInt(s[p].properties.top,10)),s[p].properties.hasOwnProperty("right")&&(a.x=this.widthInPixels-t.data.width+parseInt(s[p].properties.right,10)),s[p].properties.hasOwnProperty("left")&&(a.y=parseInt(s[p].properties.left,10)),s[p].properties.hasOwnProperty("repeat")&&"true"==s[p].properties.repeat&&(a.x=0,a.y=0,a.width=o.width,a.height=o.height,a.posFixedToCamera.x=!0,a.posFixedToCamera.y=!0,a.canBeSprite=!1),s[p].properties.hasOwnProperty("repeat-x")&&"true"==s[p].properties["repeat-x"]&&(a.x=0,a.width=o.width,a.posFixedToCamera.x=!0,a.canBeSprite=!1),s[p].properties.hasOwnProperty("repeat-y")&&"true"==s[p].properties["repeat-y"]&&(a.y=0,a.height=o.height,a.posFixedToCamera.y=!0,a.canBeSprite=!1),s[p].properties.hasOwnProperty("scale")&&(a.scale.x=parseFloat(s[p].properties.scale),a.scale.y=parseFloat(s[p].properties.scale),a.width/=a.scale.x,a.height/=a.scale.y),s[p].properties.hasOwnProperty("scale.x")&&(a.scale.x=parseFloat(s[p].properties["scale.x"],10)),s[p].properties.hasOwnProperty("scale.y")&&(a.scale.y=parseFloat(s[p].properties["scale.y"],10)),a.velocity.x=s[p].properties.hasOwnProperty("velocity.x")?parseFloat(s[p].properties["velocity.x"]):a.velocity.x,a.velocity.y=s[p].properties.hasOwnProperty("velocity.y")?parseFloat(s[p].properties["velocity.y"]):a.velocity.y,s[p].properties.hasOwnProperty("parallax")&&parseFloat(s[p].properties.parallax)>0&&(a.parallax={x:parseFloat(s[p].properties.parallax),y:parseFloat(s[p].properties.parallax)},a.canBeSprite=!1),a.canBeSprite)var y=o.add.sprite(a.x,a.y,a.imageKey);else var y=o.add.tileSprite(a.x,a.y,a.width,a.height,a.imageKey);var c=Object.keys(a);for(var d in c)y[c[d]]=a[c[d]];l.push(y),this.imageLayers.push(y)}return 0===l.length?!1:1===l.length?l[0]:l},Phaser.Plugin.TiledExtras=function(e,r){this.game=e,this.name="tiledExtras",this.map=null,this.parent=r},Phaser.Plugin.TiledExtras.prototype=Object.create(Phaser.Plugin.prototype),Phaser.Plugin.TiledExtras.prototype.constructor=Phaser.Plugin.TiledExtras,Phaser.Plugin.TiledExtras.prototype.postUpdate=function(){if(this.map){var e=this.map;if(e.hasOwnProperty("triggers"))for(var r in e.triggers)e.triggers[r].enabled&&e.triggers[r].callback&&e.triggers[r].trigged&&e.triggers[r].callback(e.triggers[r],null,!0),e.triggers[r]._resetEndorsers=!0;if(e.hasOwnProperty("imageLayers"))for(var r in e.imageLayers)0!=e.imageLayers[r].type&&(e.imageLayers[r].tilePostionOffset.x+=e.imageLayers[r].velocity.x*this.game.time.physicsElapsed,e.imageLayers[r].tilePostionOffset.y+=e.imageLayers[r].velocity.y*this.game.time.physicsElapsed,e.imageLayers[r].posFixedToCamera.x&&(e.imageLayers[r].tilePostionOffset.x+=(e.imageLayers[r].x-e.game.camera.x)*e.imageLayers[r].parallax.x,e.imageLayers[r].x=e.game.camera.x),e.imageLayers[r].posFixedToCamera.y&&(e.imageLayers[r].tilePostionOffset.y+=(e.imageLayers[r].y-e.game.camera.y)*e.imageLayers[r].parallax.y,e.imageLayers[r].y=e.game.camera.y),e.imageLayers[r].tilePosition.x=e.imageLayers[r].tilePostionOffset.x+e.imageLayers[r].adjustTilePosition.x,e.imageLayers[r].tilePosition.y=e.imageLayers[r].tilePostionOffset.y+e.imageLayers[r].adjustTilePosition.y)}},Phaser.Plugin.TiledExtras.prototype.render=function(){var e;if(this.debug)for(var r in this.map.triggers)e="rgba(100,100,255,0.9)",this.map.triggers[r].trigged&&(e="rgba(255,100,100,0.9)"),game.debug.geom({x:this.map.triggers[r].area.x,y:this.map.triggers[r].area.y,width:this.map.triggers[r].area.width,height:this.map.triggers[r].area.height},e,this.map.triggers[r].enabled,1)},Phaser.Tilemap.prototype.setCurrentMap=function(){var e=this.game;for(var r in e.plugins.plugins)if(e.plugins.plugins[r].hasOwnProperty("name")&&"tiledExtras"===e.plugins.plugins[r].name)return void(e.plugins.plugins[r].map=this)},Phaser.Tilemap.prototype.gidToTileProperties=function(e){for(var r in this.tilesets)if(this.tilesets[r].containsTileIndex(e))return this.tilesets[r].tileProperties.hasOwnProperty(e-this.tilesets[r].firstgid)?this.tilesets[r].tileProperties[e-this.tilesets[r].firstgid]:{};return console.warn("No tileset contain Gid: "+e),null},Phaser.Tilemap.prototype.tilePropertyToGid=function(e,r){var i,t,a;if("undefined"==typeof e)return void console.warn("tilePropertyToGid was called without value parameter.");for(("undefined"==typeof r||null===r)&&(r="type"),t=0;t<this.tilesets.length;t++)if(this.tilesets[t].hasOwnProperty("tileProperties"))for(i=Object.keys(this.tilesets[t].tileProperties),a=0;a<i.length;a++)if(this.tilesets[t].tileProperties[i[a]].hasOwnProperty(r)&&this.tilesets[t].tileProperties[i[a]][r]===e)return parseInt(i[a],10)+parseInt(this.tilesets[t].firstgid,10);return console.warn("Oh no! No GID found for: "+r+"="+e),!1},Phaser.TilemapLayer.prototype.setCollisionArea=function(e,r){if(r)var i={x:r.x,y:r.y,x1:r.x+r.width,y1:r.y+r.height};else var i={x:0,y:0,x1:this.map.width,y1:this.map.height};for(var t=i.y;t<i.y1;t++)for(var a=i.x;a<i.x1;a++)tile=this.map.getTile(a,t,this),tile.collideUp=!0,tile.collideRight=!0,tile.collideDown=!0,tile.collideLeft=!0,tile.collides=!0,tile.faceTop=!0,tile.faceRight=!0,tile.faceBottom=!0,tile.faceLeft=!0},Phaser.Loader.prototype.tilemapImages=function(e){var r,i=!1;if("number"==typeof e){for(var t=0;t<this._fileList.length;t++)if("tilemapImages"===this._fileList[t].type&&this.game.cache._tilemaps[this._fileList[t].key]){var i=!0;e=this._fileList[t].key,r=t;break}}else{if(this._fileList.push({key:e,loading:!1,loaded:!1,type:"tilemapImages"}),r=this._fileList.length-1,this._totalFileCount++,!this.game.cache._tilemaps.hasOwnProperty(e))return void game.load.onFileComplete.add(this.tilemapImages,this);i=!0}if(i){var a,s=this.game.cache._tilemaps[e],o=[],l={},p=Object.keys(this.game.cache._images);if(game.load.tilemap("map","assets/map.json",null,Phaser.Tilemap.TILED_JSON),!s)return void console.error("Something went horribly wrong in Phaser.Tilemap.loadAllImages!");a=s.url.match(/.*\//)[0],s=s.data;for(var t in s.tilesets)l={},l.image=s.tilesets[t].image,l.imageKey=s.tilesets[t].properties.hasOwnProperty("key")?s.tilesets[t].properties.key:s.tilesets[t].name,o.push(l);for(var t in s.layers)"imagelayer"==s.layers[t].type&&(l={},l.image=s.layers[t].image,l.imageKey=s.layers[t].properties.hasOwnProperty("key")?s.layers[t].properties.key:s.layers[t].name,o.push(l));for(var t in o){var g=!1;for(o[t].image=a+o[t].image;o[t].image.indexOf("..")>0;)o[t].image=o[t].image.replace(/([^\/\.]*?\/\.\.\/)/,"");for(var n in p)this.game.cache._images[p[n]].url!==o[t].image||(g=!0);g||(p.indexOf(o[t].imageKey)>0?console.warn("Conflicting key. Key already exists:"+o[t].imageKey):game.load.image(o[t].imageKey,o[t].image))}this._fileList.splice(r,1),this._totalFileCount--}},Phaser.TilemapLayer.prototype.updateCollision=function(e,r){var i,t=["Up","Right","Down","Left"],a=[!1,!1,!1,!1];if(e)var s={x:e.x,y:e.y,x1:e.x+e.width,y1:e.y+e.height};else var s={x:0,y:0,x1:this.map.width,y1:this.map.height};for(var o=s.y;o<s.y1;o++)for(var l=s.x;l<s.x1;l++)if(a=[!1,!1,!1,!1],i=this.map.getTile(l,o,this))if(r)i.collideUp=!1,i.collideRight=!1,i.collideDown=!1,i.collideLeft=!1,i.collides=!1;else{i.properties.hasOwnProperty("collideAll")&&"true"===i.properties.collideAll&&(a=[!0,!0,!0,!0]);for(var p=0;4>p;p++)i.properties.hasOwnProperty("collide"+t[p])&&(a[p]="true"===i.properties["collide"+t[p]]?!0:!1);if(i.flipped&&(a=[a[0],a[3],a[2],a[1]]),i.rotation>0)switch(Math.round(2*i.rotation/Math.PI)){case 1:a=[a[3],a[0],a[1],a[2]];break;case 2:a=[a[2],a[3],a[0],a[1]];break;case 3:a=[a[1],a[2],a[3],a[0]]}i.collideUp=a[0],i.collideRight=a[1],i.collideDown=a[2],i.collideLeft=a[3],i.collides=a[0]||a[1]||a[2]||a[3],i.properties.hasOwnProperty("alpha")&&(i.alpha=parseFloat(i.properties.alpha));var g=null;if(i.properties.hasOwnProperty("callback")){g=window;var n=i.properties.callback.split(".");for(var h in n){if("undefined"==g[n[h]]){g=null,console.warn("Tile callback not found: "+n[h]);break}g=g[n[h]]}i.collisionCallback=g}}this.map.calculateFaces(this.index)},Phaser.Tilemap.prototype.getTriggerByName=function(e){return e in this.triggerNames?this.triggerNames[e]:!1},Phaser.Tilemap.prototype.checkTriggers=function(e){var r,i,t;if(!this.hasOwnProperty("triggers"))return void console.warn("checkTriggers called before defineTriggers!");if(this.triggers){switch(e.type){case 0:r={x:0,y:0},i=[e];break;case 7:r={x:e.x,y:e.y},i=e.children}for(var a in i){e=i[a];var t={left:e.body.position.x,right:e.body.position.x+e.body.width-(Math.abs(e.width)-e.body.width),top:e.body.position.y,bottom:e.body.position.y+e.body.height-(Math.abs(e.height)-e.body.height),anchorX:e.x,anchorY:e.y};for(var s in this.triggers)if(this.triggers[s].enabled){if(this.triggers[s].required)switch(this.triggers[s].required.operator){case"==":if(e[this.triggers[s].required.property]!=this.triggers[s].required.value)continue;break;case"!=":if(e[this.triggers[s].required.property]!=this.triggers[s].required.value)continue;break;case"<=":if(e[this.triggers[s].required.property]>this.triggers[s].required.value)continue;break;case">=":if(e[this.triggers[s].required.property]<this.triggers[s].required.value)continue;break;case"<":if(e[this.triggers[s].required.property]>=this.triggers[s].required.value)continue;break;case">":if(e[this.triggers[s].required.property]<=this.triggers[s].required.value)continue}this.triggers[s]._resetEndorsers&&(this.triggers[s].wasTrigged=this.triggers[s].trigged,this.triggers[s].endorsers=[],this.triggers[s]._resetEndorsers=!1),t.anchorX<this.triggers[s].area.x2&&t.anchorX>this.triggers[s].area.x&&t.anchorY<this.triggers[s].area.y2&&t.anchorY>this.triggers[s].area.y?(this.triggers[s].trigged=!0,this.triggers[s].endorsers.push(e),this.triggers[s].callback&&this.triggers[s].callback(this.triggers[s],e)):this.triggers[s].wasTrigged&&0===this.triggers[s].endorsers.length&&(this.triggers[s].trigged=!1,this.triggers[s].callback&&this.triggers[s].callback(this.triggers[s],e))}}}},Phaser.Tilemap.prototype.defineTriggers=function(){if(this.setCurrentMap(),!this.objects.hasOwnProperty("triggers"))return this.triggers=null,void(this.triggerNames=null);this.triggers=[],this.triggerNames=[];for(var e,r,i=this.objects.triggers,t=null,a=0,s=i.length;s>a;a++){e={},r=Object.keys(i[a].properties),i[a].x="undefined"==typeof i[a].x?0:i[a].x,i[a].y="undefined"==typeof i[a].y?0:i[a].y;var o={name:i[a].hasOwnProperty("name")?i[a].name:null,enabled:!i[a].properties.hasOwnProperty("enabled")||"true"!==i[a].properties.enabled,callback:null,args:[],area:{x:i[a].x,y:i[a].y,width:i[a].width,height:i[a].height,x2:i[a].x+i[a].width,y2:i[a].y+i[a].height},trigged:!1,wasTrigged:!1,endorsers:[],detectAnchorOnly:i[a].properties.detectAnchorOnly,required:null,_resetEndorsers:!0};for(var l in r)"callback"!==r[l]&&"required"!==r[l]&&(e[r[l]]=i[a].properties[r[l]]);if(o.args=e,i[a].properties.hasOwnProperty("required")){for(var p=["<=",">=","==","<",">","!=",!1],l=0;7>l&&!(i[a].properties.required.indexOf(p[l])>-1);l++);p[l]&&(t=i[a].properties.required.split(p[l]),t[1]=t[1].replace(/\"/g,"").replace(/\'/g,"").replace(/\=\=\=/g,"=="),parseFloat(t[1])==t[1]&&(t[1]=parseFloat(t[1])),o.required={property:t[0],operator:p[l],value:"true"===t[1]?!0:"false"===t[1]?!1:t[1]})}i[a].properties.hasOwnProperty("detectAnchorOnly")?"false"!==i[a].properties.detectAnchorOnly&&(o.detectAnchorOnly=!0):o.detectAnchorOnly=!1;var g=null;if(i[a].properties.hasOwnProperty("callback")){g=window;var n=i[a].properties.callback.split(".");for(var l in n){if("undefined"==g[n[l]]){g=null,console.warn("Trigger callback not found: "+n[l]);break}g=g[n[l]]}o.callback=g}this.triggers.push(o),i[a].hasOwnProperty("name")&&i[a].name&&(this.triggerNames.hasOwnProperty(i[a].name)?console.warn("Duplicate trigger name: "+i[a].name+"\ngetTriggerByName will fail!"):this.triggerNames[i[a].name]=this.triggers.length-1)}0===this.triggers.length&&(this.triggers=null,this.triggerNames=null)};